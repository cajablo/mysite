---
# Documentation: https://sourcethemes.com/academic/docs/managing-content/

title: "Using OpenStreetMap Data to Map Seattle Coffee Shops"
subtitle: ""
summary: ""
authors: []
tags: []
categories: ["R"]
date: 2019-10-03T19:00:56-07:00
lastmod: 2019-10-03T19:00:56-07:00
featured: false
draft: false

# Featured image
# To use, add an image named `featured.jpg/png` to your page's folder.
# Focal points: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight.
image:
  caption: ""
  focal_point: ""
  preview_only: false

# Projects (optional).
#   Associate this post with one or more of your projects.
#   Simply enter your project's folder or file name without extension.
#   E.g. `projects = ["internal-project"]` references `content/project/deep-learning/index.md`.
#   Otherwise, set `projects = []`.
projects: []
---



<p>Seattle is well known as a coffee hub. I decided to use OpenStreetMap to explore where Seattle’s coffee shops are within the city, and explore how many of these shops belong to Starbucks versus more local chains.</p>
<p>First let’s load some packages.</p>
<pre class="r"><code>#load packages
library(tidyverse)
library(osmdata)
library(sf)
library(ggmap)
library(knitr)</code></pre>
<div id="downloading-openstreetmap-data" class="section level3">
<h3>Downloading OpenStreetMap data</h3>
<p>Using the OpenStreetMap R package (<em>osmdata</em>), we can get the locations of Seattle coffee shops.</p>
<pre class="r"><code>
q &lt;- getbb(&quot;Seattle&quot;) %&gt;%
      opq(timeout = 25) %&gt;%
      add_osm_feature(&quot;amenity&quot;, &quot;cafe&quot;) %&gt;%
      add_osm_feature(&quot;cuisine&quot;, &quot;coffee_shop&quot;)

osm_sea_coffeeshop &lt;- osmdata_sf(q)

sea_coffeeshop &lt;- osm_sea_coffeeshop[[&quot;osm_points&quot;]]

#head(sea_coffeeshop, 10) or View(sea_coffeeshop, 10) if you have RStudio</code></pre>
</div>
<div id="cleaning-and-tidying-up-the-data" class="section level3">
<h3>Cleaning and Tidying up the data</h3>
<p>It looks like there are a lot of coffee shops that don’t have anything in the <em>name</em> column, so let’s examine those rows to make sure there isn’t data in another column. I’ll do this by counting how many NA’s there are in each column by filtering the name column for just the NA’s and then counting how many NA’s there are in the rest of the columns (<em>note</em> - for display purposes I just displayed the NA count for the first 5 columns).</p>
<pre class="r"><code>explore_NA_names &lt;- sea_coffeeshop %&gt;%
  filter(is.na(name)) %&gt;%
  st_set_geometry(NULL) %&gt;%
  summarize_all(funs(sum(is.na(.)))) %&gt;%
  gather(column_name) %&gt;%
  rename(number_NAs = value)
## Warning: funs() is soft deprecated as of dplyr 0.8.0
## Please use a list of either functions or lambdas: 
## 
##   # Simple named list: 
##   list(mean = mean, median = median)
## 
##   # Auto named with `tibble::lst()`: 
##   tibble::lst(mean, median)
## 
##   # Using lambdas
##   list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))
## This warning is displayed once per session.

#print a table of all the count of NAs for all columns
explore_NA_names %&gt;%
  head() %&gt;%
  kable(col.names = c(&quot;Column Name&quot;, &quot;Number of NAs&quot;))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Column Name</th>
<th align="right">Number of NAs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">osm_id</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">name</td>
<td align="right">328</td>
</tr>
<tr class="odd">
<td align="left">access</td>
<td align="right">327</td>
</tr>
<tr class="even">
<td align="left">addr.city</td>
<td align="right">328</td>
</tr>
<tr class="odd">
<td align="left">addr.housename</td>
<td align="right">328</td>
</tr>
<tr class="even">
<td align="left">addr.housenumber</td>
<td align="right">328</td>
</tr>
</tbody>
</table>
<p>We find that of the 328 rows that had NA for the <em>name</em> column, the rest of the columns only had NA’s other than the osm_id column, so I think it’s safe to remove those rows. That leaves us with 290 coffee shops in Seattle. That’s a lot of coffee shops!</p>
<p>Before we continue, let’s do some tidying up of the data:</p>
<ul>
<li>Filter the <em>name</em> column to remove the rows with NA’s</li>
<li>Select only the relevent columns, removing the rest</li>
<li>Tidy up the <em>name</em> column to remove the special characters</li>
<li>Create a new column called <em>chain_name</em> which denotes which chain the shop belongs to (ie Zoka Coffee - Greenlake and Zoka Coffee - South Lake Union would both be under the chain <em>Zoka</em>, independent shops just keep their original name)</li>
</ul>
<pre class="r"><code>#remove rows with NA in the dataframe
sea_coffeeshop_clean &lt;- sea_coffeeshop %&gt;%
  filter(!is.na(name)) %&gt;%
  select(osm_id, name) %&gt;% #even though we aren&#39;t selecting the geometry column, b/c this is an sf object it will be automatically added to the selection
  mutate(name = str_replace(name, &quot;Ã©|Ã¨&quot;, &quot;e&quot;), name = str_replace(name, &quot;â€™&quot;, &quot;&#39;&quot;)) %&gt;% #get rid of special characters in names due to apostrophe&#39;s etc 
  mutate(chain_name = if_else(str_detect(name,&quot;Starbuck&quot;), &quot;Starbucks&quot;, name)) %&gt;%
  mutate(chain_name = if_else(str_detect(chain_name, &quot;Espresso Vivace&quot;), &quot;Espresso Vivace&quot;, chain_name)) %&gt;%
  mutate(chain_name = if_else(str_detect(chain_name, &quot;Zoka&quot;), &quot;Zoka&quot;, chain_name)) %&gt;%
  mutate(chain_name = if_else(str_detect(chain_name, &quot;Herkimer Coffee&quot;), &quot;Herkimer Coffee&quot;, chain_name)) %&gt;%
  mutate(chain_name = if_else(str_detect(chain_name, &quot;Chaco Canyon Organic&quot;), &quot;Chaco Canyon Organic Cafe&quot;, chain_name)) %&gt;%
  mutate(chain_name = if_else(str_detect(chain_name, &quot;Cherry Street Coffee&quot;), &quot;Cherry Street Coffee House&quot;, chain_name)) %&gt;%
  mutate(chain_name = if_else(str_detect(chain_name, &quot;Chocolati&quot;), &quot;Chocolati Cafe&quot;, chain_name)) </code></pre>
</div>
<div id="how-many-starbuck-locations-are-in-seattle" class="section level3">
<h3>How Many Starbuck locations are in Seattle?</h3>
<p>Since Seattle is the original home to Starbucks, let’s see how many Starbucks and other chains are in the city.</p>
<pre class="r"><code>sea_chains &lt;- sea_coffeeshop_clean %&gt;%
  st_set_geometry(NULL) %&gt;%
  count(chain_name, sort = TRUE) %&gt;%
  filter(n &gt; 1) %&gt;%
  rename(number_shops = n)

kable(sea_chains,
      col.names = c(&quot;Chain name&quot;, &quot;Number of Shops&quot;))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Chain name</th>
<th align="right">Number of Shops</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Starbucks</td>
<td align="right">91</td>
</tr>
<tr class="even">
<td align="left">Cherry Street Coffee House</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">Caffe Ladro</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">Uptown Espresso</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">Caffe Vita</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">Zoka</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">Caffe Appassionato</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Caffe Umbria</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Diva Espresso</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Espresso Vivace</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Herkimer Coffee</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Peet’s Coffee</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Storyville Coffee</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Tougo Coffee Co.</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Victrola Coffee Roasters</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Cafe Solstice</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Chaco Canyon Organic Cafe</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">Chocolati Cafe</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Cupcake Royale</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">Fuel</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Pegasus Coffee</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">Realfine Coffee</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Slate Coffee Roasters</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">Voxx Coffee</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Youngstown Coffee Co.</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
<div id="mapping-coffee-shops-in-seattle" class="section level3">
<h3>Mapping Coffee Shops in Seattle</h3>
<p>Let’s download the Seattle city limits using the <a href="https://hub.arcgis.com/datasets/5a500937601b4382bc0f6edfca3c9ca5_2237">City Council Districts file</a> from King County GIS Open Data Portal using the sf function <em>st_read()</em>. For GIS data available made available via an API this function is really convenient. The <em>st_union()</em> function unions the city council districts into one polygon of the Seattle city limits.</p>
<pre class="r"><code>seattle_limits &lt;- st_read(&quot;https://opendata.arcgis.com/datasets/5a500937601b4382bc0f6edfca3c9ca5_2237.geojson&quot;) %&gt;%
  st_union()
## Reading layer `5a500937601b4382bc0f6edfca3c9ca5_2237&#39; from data source `https://opendata.arcgis.com/datasets/5a500937601b4382bc0f6edfca3c9ca5_2237.geojson&#39; using driver `GeoJSON&#39;
## Simple feature collection with 7 features and 5 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -122.4412 ymin: 47.49523 xmax: -122.236 ymax: 47.73417
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs</code></pre>
<p>To create a background map for the maps, I created a bounding box from the <em>seattle_limits</em> file and then used the <em>get_stamenmap()</em> which pulls the tiles from <a href="http://maps.stamen.com/#watercolor/12/37.7706/-122.3782">Stamen Design</a>.</p>
<p>All Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</p>
<pre class="r"><code>seattle_bbox &lt;- as.vector(st_bbox(seattle_limits))
sea_map &lt;- get_stamenmap(seattle_bbox, zoom = 12, maptype = &quot;toner-background&quot;) %&gt;% ggmap()</code></pre>
<p>Here I created a map of all of the Starbucks in Seattle using <em>ggplot2</em></p>
<pre class="r"><code>sea_starbucks &lt;- sea_coffeeshop_clean %&gt;%
  filter(chain_name %in% &quot;Starbucks&quot;) %&gt;%
  mutate(lat = unlist(map(geometry,2)),
         lon = unlist(map(geometry,1))) %&gt;%
  st_intersection(seattle_limits)

sea_map +
  geom_point(data = sea_starbucks, 
             aes(x = lon, y = lat), 
             color = &quot;forestgreen&quot;, 
             alpha = .6) +
  theme_minimal() +
  labs(title = &quot;Starbucks Location in Seattle&quot;,
       caption = &quot;Source: OpenStreetMap, King County GIS, Stamen Design&quot;,
       x = &quot;&quot;,
       y = &quot;&quot;) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.caption = element_text(size = 7,
                                hjust = .5,
                                margin = margin(t = 0.2,
                                                b = 0,
                                                unit = &quot;cm&quot;),
                                color = &quot;#939184&quot;),
        plot.title = element_text(size = 15, hjust = 0.5)
        )</code></pre>
<p><img src="/post/using-open-street-maps-to-map-seattle-coffee-shops_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>I also decided to create another map of all of the <em>independent</em> coffee shops in Seattle, ie not Starbucks or Peets coffee (it’s possible there were some other national chains on the list that I just didn’t recognize).</p>
<pre class="r"><code>sea_ind_coffee &lt;- sea_coffeeshop_clean %&gt;%
  filter(!(chain_name %in% &quot;Starbucks&quot;) | !(chain_name %in% &quot;Peet&quot;)) %&gt;%
  mutate(lat = unlist(map(geometry,2)),
         lon = unlist(map(geometry,1))) %&gt;%
  st_intersection(seattle_limits)

sea_map +
  geom_point(data = sea_ind_coffee, 
             aes(x = lon, y = lat), 
             color = &quot;purple&quot;, 
             alpha = .4) +
  theme_minimal() +
  #coord_sf(crs = 4269, datum = NA) +
  labs(title = &quot;Independent Coffee Shops in Seattle&quot;,
       caption = &quot;Source: OpenStreetMap, King County GIS, Stamen Design&quot;,
       x = &quot;&quot;,
       y = &quot;&quot;) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.caption = element_text(size = 7,
                                hjust = .5,
                                margin = margin(t = 0.2,
                                                b = 0,
                                                unit = &quot;cm&quot;),
                                color = &quot;#939184&quot;),
        plot.title = element_text(size = 15, hjust = 0.5)
        )</code></pre>
<p><img src="/post/using-open-street-maps-to-map-seattle-coffee-shops_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>For fun I also creaded a quick map of areas of a high density of Starbucks using <em>stat_density2d()</em> from <em>ggplot2</em>.</p>
<pre class="r"><code>sea_map + stat_density2d(
    aes(x = lon, 
        y = lat, 
        fill = ..level.., 
        alpha = 1/20),
    size = 2, bins = 20, 
    data = sea_starbucks,
    geom = &quot;polygon&quot;
  ) +
  theme_minimal() +
  labs(title = &quot;Density of Starbucks in Seattle&quot;,
       caption = &quot;Source: OpenStreetMap, King County GIS, Stamen Design&quot;,
       x = &quot;&quot;,
       y = &quot;&quot;) +
  scale_fill_gradient(low = &quot;light green&quot;, high = &quot;forest green&quot;) +
  theme(text = element_text(color = &quot;black&quot;),
        panel.border = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.caption = element_text(size = 7,
                                hjust = .5,
                                margin = margin(t = 0.2,
                                                b = 0,
                                                unit = &quot;cm&quot;),
                                color = &quot;#939184&quot;),
        plot.title = element_text(size = 15, hjust = 0.5)
        )</code></pre>
<p><img src="/post/using-open-street-maps-to-map-seattle-coffee-shops_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="resources" class="section level3">
<h3>Resources</h3>
<p>Here are some websites that are useful for working with OpenStreetMap data</p>
<ul>
<li><a href="https://dominicroye.github.io/en/2018/accessing-openstreetmap-data-with-r/" class="uri">https://dominicroye.github.io/en/2018/accessing-openstreetmap-data-with-r/</a> (helpful tutorial on working with OpenStreetMaps + osmr package)</li>
<li><a href="http://overpass-turbo.eu/" class="uri">http://overpass-turbo.eu/</a> (allows you explore OpenStreetMap Data)</li>
<li><a href="https://wiki.openstreetmap.org/wiki/Map_Features" class="uri">https://wiki.openstreetmap.org/wiki/Map_Features</a> (OpenStreetMap wiki for map features, helpful for building queries)</li>
</ul>
</div>
